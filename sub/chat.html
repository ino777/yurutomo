<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <h1>My Chat</h1>
    <div id="join-content">
        Username: <input type="text" id="input-username" /><br>
        Room: <input type="text" id="input-room"><button id="join-chat">Join</button>
    </div>

    <div id="chat-content" action="" hidden>
        <div id="selfname"></div>
        <div id="roomname"></div>
        Message : <input type="text" id="input-message" autocomplete="off" autofocus /><button id="send-button">Send</button>
        <button id="leave-chat">Leave</button>
    </div>

    <ul id="list-message"></ul>


    <script>
        let ws_scheme = window.location.protocol == "https:" ? "wss": "ws";
        const socket = new WebSocket(ws_scheme + "://" + window.location.host + "/ws/chat/");
        
        let g_username = "";
        let g_room = "";


        // Joinボタン押下でユーザーネームを送信しチャットに参加
        $("#join-chat").on("click", function(){
            g_username = $("#input-username").val();
            g_room = $("#input-room").val();
            joinChat(g_username, g_room);

            
            // 画面遷移でチャット画面へ
            $("#join-content").hide();
            $("#chat-content").show();

            // チャット画面に自分の名前表示
            $("#selfname").html(g_username);
            $("#roomname").html(g_room);
        })

        // チャットに参加
        function joinChat(username, room){
            socket.send(JSON.stringify(
                {
                    "data_type": "join",
                    "username": username,
                    "room": room,
                }
            ))
        }

        // Leaveボタン押下でチャットを退出
        $("#leave-chat").on("click", function(){
            leaveChat();
            
            // ページをリロード
            location.reload()
        })

        //チャットルームを退出
        function leaveChat(){
            socket.send(JSON.stringify(
                {
                    "data_type": "leave",
                }
            ))
        }

        // Sendボタン押下でメッセージ送信
        $("#send-button").on("click", function(){
            let message = $("#input-message").val();
            if (!message){
                return;
            }

            // Websocketを通したメッセージ送信
            socket.send(JSON.stringify(
                {
                    "data_type": "message",
                    "message": message
                }
            ));

            // 空にする
            $("#input-message").val("");
        });


        // メッセージ受信時の処理
        socket.onmessage = function(event){
            let data = JSON.parse(event.data);

            let message = data["message"];
            let username = data["username"];
            let datetime = data["datetime"];

            $("<li>", {
                text: message + " - " + username + " - " + datetime,
            }).prependTo("#list-message");
        }

        // Websocketクローズ時の処理
        socket.onclose = function(event){
            console.error("Unexpected: Chat socket closed");
        }
    </script>

</body>
</html>